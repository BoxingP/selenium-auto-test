---
- name: install pytest
  pip:
    name:
      - allure-pytest==2.9.45
      - pytest==6.2.5
      - pytest-rerunfailures==10.2
      - pytest-xdist==2.5.0
    virtualenv: /tmp/pytest/python
    virtualenv_command: /usr/bin/python3 -m venv
  become: yes

- name: install selenium
  pip:
    name:
      - selenium==3.141.0
    virtualenv: /tmp/selenium/python
    virtualenv_command: /usr/bin/python3 -m venv
  become: yes

- name: check for chromedriver
  changed_when: false
  stat:
    path: '/tmp/chromedriver_linux64.zip'
  register: chromedriver_result

- name: download chromedriver from remote
  when: not chromedriver_result.stat.exists
  get_url:
    url: https://chromedriver.storage.googleapis.com/2.43/chromedriver_linux64.zip
    dest: '/tmp/chromedriver_linux64.zip'
    checksum: sha1:63bce01580d6bc488aa185d572500f342f10eeef
    timeout: 180

- name: check for headless chromium
  changed_when: false
  stat:
    path: '/tmp/headless_chromium_69.zip'
  register: headless_chromium_result

- name: download headless chromium from remote
  when: not headless_chromium_result.stat.exists
  get_url:
    url: https://github.com/adieuadieu/serverless-chrome/releases/download/v1.0.0-55/stable-headless-chromium-amazonlinux-2017-03.zip
    dest: '/tmp/headless_chromium_69.zip'
    checksum: sha1:85f5dd46b7191e2f025ec73e3b20e8c418a21d67
    timeout: 300

- name: create chromedriver directory
  file:
    path: /tmp/chromedriver
    state: directory
  become: yes

- name: extract files into directory
  unarchive:
    src: '{{ item }}'
    dest: /tmp/chromedriver
    remote_src: yes
  loop:
    - /tmp/chromedriver_linux64.zip
    - /tmp/headless_chromium_69.zip
  become: yes

- name: check for allure
  changed_when: false
  stat:
    path: '/tmp/allure-2.16.1.zip'
  register: allure_result

- name: download allure from remote
  when: not allure_result.stat.exists
  get_url:
    url: https://github.com/allure-framework/allure2/releases/download/2.16.1/allure-2.16.1.zip
    dest: '/tmp/allure-2.16.1.zip'
    checksum: sha1:d67dae4327e0b9ebb892c5a8269e8fa604bcaa96
    timeout: 300

- name: create allure directory
  file:
    path: /tmp/allure
    state: directory
  become: yes

- name: extract files into directory
  unarchive:
    src: '{{ item }}'
    dest: /tmp/allure
    remote_src: yes
  loop:
    - /tmp/allure-2.16.1.zip
  become: yes

- name: enable custom logo plugin in allure
  lineinfile:
    path: '/tmp/allure/allure-2.16.1/config/allure.yml'
    line: '  - custom-logo-plugin'
    insertafter: EOF
    state: present
  become: yes

- name: install psycopg2
  block:

    - name: check for postgresql
      changed_when: false
      stat:
        path: '/tmp/postgresql-11.12.tar.bz2'
      register: postgresql_result

    - name: download postgresql from remote
      when: not postgresql_result.stat.exists
      get_url:
        url: https://ftp.postgresql.org/pub/source/v11.12/postgresql-11.12.tar.bz2
        dest: '/tmp/postgresql-11.12.tar.bz2'
        checksum: sha1:4058af97fde72064c5fd18a508eda6a5526359df
        timeout: 300

    - name: check for psycopg2
      changed_when: false
      stat:
        path: '/tmp/psycopg2-2_9_3.tar.gz'
      register: psycopg2_result

    - name: download psycopg2 from remote
      when: not psycopg2_result.stat.exists
      get_url:
        url: https://github.com/psycopg/psycopg2/archive/refs/tags/2_9_3.tar.gz
        dest: '/tmp/psycopg2-2_9_3.tar.gz'
        checksum: sha1:9a9d9275a76e49d59c999e18dfaac1d61b671832
        timeout: 300

    - name: extract files into directory
      unarchive:
        src: '{{ item.file }}'
        dest: '{{ item.directory }}'
        remote_src: yes
      loop:
        - file: /tmp/postgresql-11.12.tar.bz2
          directory: /tmp
        - file: /tmp/psycopg2-2_9_3.tar.gz
          directory: /tmp

    - name: build postgresql
      shell: |
        ./configure --prefix "/tmp/pg" --without-readline --without-zlib &&
        make &&
        make install
      args:
        chdir: '/tmp/postgresql-11.12'
      become: yes

    - name: build psycopg2
      shell: |
        sed -ri -e "s#pg_config=.*#pg_config=/tmp/pg/bin/pg_config#" setup.cfg &&
        sed -ri -e "s#static_libpq=.*#static_libpq=1#" setup.cfg &&
        python3 setup.py build
      args:
        chdir: '/tmp/psycopg2-2_9_3'
      become: yes

    - name: create psycopg2 directory
      file:
        path: /tmp/psycopg2/python
        state: directory

    - name: generate psycopg2 directory content
      shell: |
        cp -pR build/lib.*/* /tmp/psycopg2/python &&
        strip /tmp/psycopg2/python/psycopg2/*.so
      args:
        chdir: '/tmp/psycopg2-2_9_3'

- name: install sqlalchemy
  pip:
    name:
      - SQLAlchemy==1.4.32
    virtualenv: /tmp/sqlalchemy/python
    virtualenv_command: /usr/bin/python3 -m venv
  become: yes

- name: get play directory
  set_fact:
    play_path: '{{ hostvars["localhost"]["code"]["local_path"] }}'

- name: import users' credentials
  copy:
    src: 'vars/selenium_auto_test_users.json'
    dest: '{{ play_path }}/lambda/test_website/utils/users.json'
    force: yes
  become: yes

- name: fetch files from remote
  fetch:
    src: '{{ play_path }}/{{ item.path }}'
    dest: '/tmp/{{ item.file }}'
    flat: yes
    fail_on_missing: yes
  loop:
    - { file: 'config.yaml', path: 'config.yaml' }
    - { file: 'test_website_config.json.j2', path: 'lambda/test_website/config.json.j2' }
    - { file: 'parse_report_config.json.j2', path: 'lambda/parse_report/config.json.j2' }

- name: load variables from config file
  include_vars:
    file: '/tmp/config.yaml'

- name: upload to remote
  template:
    src: '/tmp/{{ item.template }}'
    dest: '{{ play_path }}/{{ item.path }}'
    force: yes
  loop:
    - { template: 'test_website_config.json.j2', path: 'lambda/test_website/config.json' }
    - { template: 'parse_report_config.json.j2', path: 'lambda/parse_report/config.json' }